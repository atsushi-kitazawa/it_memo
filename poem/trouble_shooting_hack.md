# トラブルシューティングについて

## 今日伝えたいこと
    ・「試験でつまった」、「開発でデバッグする」、「保守で顧客事象を解析する」
    　これら全部広い意味ではトラシューになる
    　(日々の業務のかなりの部分をトラシューが占める)
    ・トラシューは広範囲の知識、スキル、さらに経験が必要
    　(まさにエンジニアの総合格闘技！)

## トラシューとは
    ・事象(トラブル)の原因を突き止めて、解消すること

## トラシューの極意
    目の前の事象はそれぞれがユニーク
    「これを覚えておけばオールOK」というものはない

    ただ、ある程度決まった型は存在するので、まずはその”型”を抑えるところから
    あとは日々自身の型を磨き、引き出し(知識、スキル、経験)を増やしていくと
    どんどんトラシューがうまくなる

## トラシューの型
    多少前後することもあるが、基本的な流れは以下のようになる
        １. 実施前に必要な情報を揃える
        ２. 再現を試みる
        ３. 仮設を立てる
        ４. 原因箇所を絞り込む
        ５. 原因特定のために情報を集める(Web、メトリック、トレース etc)
        ６. 調査した方法を試してみる
        ７. 解消することを確認する
    
    特に重要なのは、
        １の事前情報がどれだけ集まるか
        ２の再現ができるか
    の２つ。この２つによってその後の運命が大きく左右される

    全体を通して意識すること
        ・原因を絞り込む
        ・どの仮設に対して今調査しているのか見失わない
        ・煮詰まったら振り出しに戻ってみる

## 各フェーズについて
    １ から ７ の各フェーズで実施する内容はそれぞれ下記の通り。

### １. 実施前に必要な情報を揃える
    以下の情報を集める(不明かどうかも含めて確認する)
        ・事象発生時のメッセージ情報
        ・アプリの挙動、事象詳細
        ・環境情報（OS、ミドル、パッチなどを極力細かいレベルで）
            ※場合によってはカーネルバージョンなどの下位レイヤが必要となる場合もある
        ・発生時のオペレーション
        ・発生時刻
        ・発生時のアプリケーション、OSのログ
        ・条件はあるか（特定の時間帯のみ発生する、特定ユーザのみ発生するなど）

### ２. 再現を試みる
    自身の環境にて再現を試みる
    ここで再現できるかが、大きな分かれ目

    ◆なぜ再現が大事なのか
        ・トラシューは調査した内容をいろいろ試せることが大事
        　自身の環境なら好きなように試すことができる
        ・試す回数(試行回数)が多ければそれだけ原因に近づくことができる
        ・解消を確認するには再現が必須になる
        ・欲を言うと”簡易な手順”での再現方法が確立できるとなお良し
    
    また、この段階で
        ・最小限のサンプルアプリでの再現する
        ・最小限の構成で再現する
    とできるとさらいに良い
        ※ 例えば、Web -　AP - DB の３層のシステムの場合、Webサーバなしで
        　再現するか、など(調査対象を捨てられるというのが大事)

    当然再現できない場合もある。。。この場合は大変。
        ・再現環境でこちらが調査した結果を試してもらう必要がある
        　(試行回数が上がらない)
        ・解消確認も再現する環境で行う必要がある
        　(本番環境だと非常に試しづらい)

### ３. 仮設を立てる
    事象と再現からある程度、原因の仮設を立ててみる
    その仮設が正しいか確かめるようにこのあとの調査を進めていくのがコツ

    ◆なぜ仮設を立てるのか
        トラシューは調査範囲が広くなることが多々ある
        やみくもにやってると収拾がつかなくなるので、
        仮設を立ててそこを調査する(はずしたら次の仮設をたててという感じ)
    
    当然仮設を立てるには経験が必要
    最初は難しいけどトラシューを重ねるうちにできるようになるので心配なく！

### ４. 原因箇所を絞り込む
    どこか事象の原因なのかを絞り込む
    とにかく調査対象の範囲を狭くすることが大切

    主な観点は以下の通り
        ・クライアント側の問題か、サーバ側の問題か
        ・サーバに原因があるのか
        ・中間に位置するNW機器に原因があるのか
        ・アプリケーションに原因があるか
        ・アプリケーションならソースコードの問題か、設定の問題か
        ・ソースコードならどのクラスの問題か
        ・ライブラリの問題か
        ・OSの問題か

    アーキテクチャ(構成図)を抑えることがポイント

### ５. 原因特定のために情報を集める(Web、メトリック、トレース etc)
    ここが一番知識、スキル、経験がものをいうフェーズ
    それらを総動員して原因特定に邁進する

        ・ログ、メッセージなどのキーワードをもとに Web検索する
        　検索キーワードは工夫する(site:検索、言語設定を英語にして英語検索するなど)
        ・デバッグログを出してみる
        ・ログなどをもとにソースコードを静的解析
        ・動的解析(デバッグ)の実施
        ・関連しそうな設定を突き止める
        ・調査ツールを利用してメトリック、トレース情報を取得
        ・ミドルやライブラリのバグ情報を検索する
    
    検索を超重要
        基本はドキュメントなどの一次情報をあたる
        stackoverflowなどのデファクトなサイトはおさえておく
        バグ情報は Bugzilla など各ミドルで公開場所が決まっているので確認しておく

### ６. 調査した方法を試してみる
    調査結果した内容を試してみる
    
    ここで自身の環境で再現ができていないとこれをお客様等に依頼しなければ
    ならなず、苦しい。

### ７. 解消することを確認する
    解消すれば無事トラシュー終了。
    トラシュー後は誰かに報告することがだいたいなので調査結果をまとめる。

    解消しなければ３に戻る。以降繰り返し。

## トラシューのやりやすさにかかわる要素
    上記を見てわかる通り、トラシューは「どの範囲まで自身で触ることができるか」
    がやりやすさにかなり関わってくる。

    例えば、
        ・自身の環境で再現しないとお客様等、再現環境を持った第三者を巻き込む必要がある
        ・アプリが自身で開発したものでない場合、ソースコードは見えれない(見るハードルが高い)
        ・ミドルやライブラリ、さらにOSまでくると事実上ブラックボックス
    など。

    原因箇所が自身の得意分野に落ちてきた場合は、当然ながらやりやすい
    知らない分野だど、その知識を埋める作業もついてくるので時間がかかってしまう
    (だから知識、スキルを増やす必要がある)

    情報取得のツールを知っていることは重要。
    「この情報がみたい」となったときにサクッと情報が取れると強い
    そもそもツール等を知らなければそうゆう情報をとりたいともならないかもしれない

## Javaアプリケーションのトラシューによく使われるログやツール達
    ・GCログ
        - 用途
            JVMのGC状況を記録したログ
            メモリ逼迫、メモリリークの調査の際に有用な情報となりうる
        - 取得方法
            起動オプションで指定
    ・スレッドダンプ
        - 用途
            取得時のスレッドの状態のスナップショット
            アプリが無応答になった、CPU使用率が高騰したというような事象の場合に
            有用な情報になりうる
            調査の際は事象発生の際に一定間隔で複数回取得する必要がある場合が多い
        - 取得方法
            jstack コマンド
    ・ヒープダンプ
        - 用途
            JVMのヒープ状況を確認できるもの
            メモリ逼迫、メモリリークの調査の際に有用な情報となりうる
        - 取得方法
            jmap コマンド
            起動オプションで OOME(OutOfMemoryError)発生時に取得するように設定可
    ・Fatal Error Log
        - 用途
            JVMがクラッシュした場合に出力されるログ
            hs_err_pid.log という名前のファイル
            だいたいは JVM のバグが原因となるので Java Bug Database で不具合情報
            を探してみる
        - 取得方法
            クラッシュ時 JVM側で勝手に出力してくれるので設定不要
## 例題
* 事象
  * アプリケーションのCPU使用率が高騰した
* 観点
  * 無限ループ、重い処理が実行されている可能性がある
* 調査方法
  * 高騰しているプロセスを特定
  * プロセスのスレッドの状態を確認して**どのスレッドがどの処理**で
    CPUを使っていそうか確認
  * スレッドダンプをもとにアプリケーションソースコードを確認する
  * 事象発生時のログから行われていた処理を確認する

* 事象
  * アプリケーションが無応答になった
* 観点
  * なにかの処理待ちとなっている可能性がある
* 調査方法
  * CPU使用率を確認してみる。
  * 高騰してる場合、スレッドダンプなどからどの処理が行われているか確認する
  * 高騰は特にしていない場合、I/O待ちの可能性がある。書き込み/読み込み先、通信先で時間がかかるような処理が行われていないか確認する

* 事象
  * 表示データがおかしくなった
* 観点
  * どこでおかしくなったのか「クライアントで？」、「Webサーバで？」、「APサーバで？」、「DBで？」を絞り込む。
* 調査方法
  * 最小限の構成での再現を試みる
  * 発生場所を特定後、当該場所にて原因を調査する。(Webサーバなら設定が悪いのか、APサーバならアプリのバグなのか、など)

